{% extends "base.html" %}

{% block title %}{{ 'Edit' if stay else 'New' }} Stay{% endblock %}

{% block content %}
    <div class="container">
        <h1>{{ 'Edit' if stay else 'New' }} Stay</h1>
        <form id="stayForm" class="stay-form">
            <div class="form-section">
                <h2>Stay Details</h2>
                <div class="form-group">
                    <label for="resort">Resort:</label>
                    <input type="text" id="resort" name="resort" value="{{ stay.resort if stay else '' }}" required>
                </div>

                <div class="form-group">
                    <label for="check_in">Check-in:</label>
                    <input type="date" id="check_in" name="check_in"
                           value="{{ stay.check_in.strftime('%Y-%m-%d') if stay else '' }}" required>
                </div>

                <div class="form-group">
                    <label for="check_out">Check-out:</label>
                    <input type="date" id="check_out" name="check_out"
                           value="{{ stay.check_out.strftime('%Y-%m-%d') if stay else '' }}" required>
                </div>

                <div class="form-group">
                    <label for="points_cost">Total Points:</label>
                    <input type="number" id="points_cost" name="points_cost"
                           value="{{ stay.points_cost if stay else '' }}" required min="1">
                </div>

                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" name="status" required>
                        <option value="Planned" {% if stay and stay.status == 'Planned' %}selected{% endif %}>Planned</option>
                        <option value="Booked" {% if stay and stay.status == 'Booked' %}selected{% endif %}>Booked</option>
                        <option value="Completed" {% if stay and stay.status == 'Completed' %}selected{% endif %}>Completed</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h2>Members</h2>
                <div id="members-container">
                    {% if stay %}
                        {% for member_share in stay.stay_members %}
                            <div class="member-row">
                                <select class="member-select" required>
                                    {% for member in members %}
                                        <option value="{{ member.id }}"
                                                {% if member.id == member_share.member_id %}selected{% endif %}>
                                            {{ member.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <input type="number" class="points-share" value="{{ member_share.points_share }}" required min="0">
                                <button type="button" class="remove-member">Remove</button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <button type="button" id="add-member">Add Member</button>
                <div class="points-summary">
                    Total Points Allocated: <span id="total-points">0</span>
                    <span id="points-warning" style="color: red; display: none;">
                        Points allocation does not match total cost
                    </span>
                </div>
            </div>

            <div class="form-section">
                <h2>Guests</h2>
                <div id="guests-container">
                    {% if stay %}
                        {% for guest in stay.additional_guests %}
                            <div class="guest-row">
                                <select class="guest-select" required>
                                    {% for available_guest in guests %}
                                        <option value="{{ available_guest.id }}"
                                                {% if available_guest.id == guest.id %}selected{% endif %}>
                                            {{ available_guest.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="remove-guest">Remove</button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <button type="button" id="add-guest">Add Guest</button>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">{{ 'Save Changes' if stay else 'Create Stay' }}</button>
                <a href="{{ url_for('home') }}" class="btn-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <style>
    .stay-form {
        max-width: 800px;
        margin: 0 auto;
    }

    .form-section {
        margin-bottom: 2rem;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .member-row, .guest-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.5rem;
        align-items: center;
    }

    .points-summary {
        margin-top: 1rem;
        padding: 0.5rem;
        background-color: #f5f5f5;
        border-radius: 4px;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        text-decoration: none;
        display: inline-block;
    }

    .remove-member, .remove-guest {
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        cursor: pointer;
    }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('stayForm');
        const membersContainer = document.getElementById('members-container');
        const guestsContainer = document.getElementById('guests-container');
        const addMemberBtn = document.getElementById('add-member');
        const addGuestBtn = document.getElementById('add-guest');
        const pointsCostInput = document.getElementById('points_cost');
        const totalPointsSpan = document.getElementById('total-points');
        const pointsWarning = document.getElementById('points-warning');

        function createMemberRow() {
            const div = document.createElement('div');
            div.className = 'member-row';
            div.innerHTML = `
                <select class="member-select" required>
                    {% for member in members %}
                        <option value="{{ member.id }}">{{ member.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" class="points-share" required min="0">
                <button type="button" class="remove-member">Remove</button>
            `;
            return div;
        }

        function createGuestRow() {
            const div = document.createElement('div');
            div.className = 'guest-row';
            div.innerHTML = `
                <select class="guest-select" required>
                    {% for guest in guests %}
                        <option value="{{ guest.id }}">{{ guest.name }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="remove-guest">Remove</button>
            `;
            return div;
        }

        function updatePointShares() {
            const totalPoints = parseInt(pointsCostInput.value) || 0;
            const memberRows = membersContainer.querySelectorAll('.member-row');
            if (memberRows.length === 0) return;

            const pointsPerMember = Math.floor(totalPoints / memberRows.length);
            const remainder = totalPoints % memberRows.length;

            memberRows.forEach((row, index) => {
                const pointsInput = row.querySelector('.points-share');
                pointsInput.value = pointsPerMember + (index < remainder ? 1 : 0);
            });

            updateTotalPoints();
        }

        function updateTotalPoints() {
            let total = 0;
            membersContainer.querySelectorAll('.points-share').forEach(input => {
                total += parseInt(input.value) || 0;
            });
            totalPointsSpan.textContent = total;

            const targetPoints = parseInt(pointsCostInput.value) || 0;
            pointsWarning.style.display = total !== targetPoints ? 'inline' : 'none';
        }

        // Event Listeners
        addMemberBtn.addEventListener('click', () => {
            membersContainer.appendChild(createMemberRow());
            updatePointShares();
        });

        addGuestBtn.addEventListener('click', () => {
            guestsContainer.appendChild(createGuestRow());
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-member')) {
                e.target.closest('.member-row').remove();
                updatePointShares();
            } else if (e.target.classList.contains('remove-guest')) {
                e.target.closest('.guest-row').remove();
            }
        });

        pointsCostInput.addEventListener('change', updatePointShares);

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = {
                resort: document.getElementById('resort').value,
                check_in: document.getElementById('check_in').value,
                check_out: document.getElementById('check_out').value,
                points_cost: parseInt(pointsCostInput.value),
                status: document.getElementById('status').value,
                members: [],
                guests: []
            };

            membersContainer.querySelectorAll('.member-row').forEach(row => {
                formData.members.push({
                    member_id: parseInt(row.querySelector('.member-select').value),
                    points_share: parseInt(row.querySelector('.points-share').value)
                });
            });

            guestsContainer.querySelectorAll('.guest-row').forEach(row => {
                formData.guests.push(parseInt(row.querySelector('.guest-select').value));
            });

            const url = '{{ url_for("add_stay") if not stay else url_for("update_stay", stay_id=stay.id) }}';
            const method = '{{ "POST" if not stay else "PUT" }}';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    window.location.href = '{{ url_for("home") }}';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the stay');
            });
        });

        // Initialize points if editing
        if (membersContainer.querySelectorAll('.member-row').length > 0) {
            updateTotalPoints();
        }
    });
    </script>
{% endblock %}
