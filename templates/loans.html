{% extends "base.html" %}

{% block title %}Loans{% endblock %}

{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>DVC Points Tracker - Point Loans</title>
    <style>
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .container { margin: 20px; }
        .nav { margin-bottom: 20px; }
        form { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        form div { margin: 10px 0; }
        label { display: inline-block; width: 100px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="{{ url_for('home') }}">← Back to Home</a>
        </div>

        <h1>Point Loans</h1>

        <div class="point-sharing-section">
            <h2>Point Sharing</h2>

            <!-- Form to record new point sharing -->
            <form method="POST" action="{{ url_for('create_loan') }}" onsubmit="return createLoan(event)">
                <div class="form-group">
                    <label for="lender_id">Sharing From:</label>
                    <select name="lender_id" id="lender_id" required>
                        {% for member in members %}
                        <option value="{{ member.id }}">{{ member.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="borrower_id">Sharing To:</label>
                    <select name="borrower_id" id="borrower_id" required>
                        {% for member in members %}
                        <option value="{{ member.id }}">{{ member.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="points">Points:</label>
                    <input type="number" name="points" id="points" required min="1">
                </div>

                <div class="form-group">
                    <label for="use_year">Use Year:</label>
                    <input type="number" name="use_year" id="use_year" value="{{ current_year }}" required>
                </div>

                <button type="submit">Record Point Sharing</button>
            </form>

            <!-- Point sharing summary -->
            <h3>Current Point Sharing Summary</h3>
            <div class="sharing-summary">
                {% for key, share in point_shares.items() %}
                    {% if share.net_points != 0 %}
                    <div class="sharing-entry">
                        <h4>{{ share.members[0] }} ↔ {{ share.members[1] }}</h4>
                        <p class="net-points {% if share.net_points > 0 %}positive{% else %}negative{% endif %}">
                            Net points: {{ share.net_points }}
                            {% if share.net_points > 0 %}
                                ({{ share.members[1] }} owes {{ share.members[0] }})
                            {% else %}
                                ({{ share.members[0] }} owes {{ share.members[1] }})
                            {% endif %}
                        </p>

                        <details>
                            <summary>Transaction History</summary>
                            <table class="transaction-history">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Points</th>
                                        <th>Use Year</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in share.transactions %}
                                    <tr>
                                        <td>{{ transaction.date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ transaction.lender }}</td>
                                        <td>{{ transaction.borrower }}</td>
                                        <td>{{ transaction.points }}</td>
                                        <td>{{ transaction.use_year }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </details>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Recent Activity -->
            <h3>Recent Point Sharing Activity</h3>
            <div class="activity-log">
                {% for activity in activities %}
                <div class="activity-entry">
                    <span class="timestamp">{{ activity.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                    <span class="description">{{ activity.description }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <h2>Active Loans</h2>
        <table>
            <thead>
                <tr>
                    <th>Lender</th>
                    <th>Borrower</th>
                    <th>Points</th>
                    <th>Use Year</th>
                    <th>Date Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for loan in active_loans %}
                <tr>
                    <td>{{ loan.lender.name }}</td>
                    <td>{{ loan.borrower.name }}</td>
                    <td>{{ loan.points }}</td>
                    <td>{{ loan.use_year }}</td>
                    <td>{{ loan.timestamp.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <button onclick="handleRepayLoan({{ loan.id }})">Repay Loan</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>Repaid Loans</h2>
        <table>
            <thead>
                <tr>
                    <th>Lender</th>
                    <th>Borrower</th>
                    <th>Points</th>
                    <th>Use Year</th>
                    <th>Repay Year</th>
                    <th>Date Created</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for loan in repaid_loans %}
                <tr>
                    <td>{{ loan.lender.name }}</td>
                    <td>{{ loan.borrower.name }}</td>
                    <td>{{ loan.points }}</td>
                    <td>{{ loan.use_year }}</td>
                    <td>{{ loan.repay_year }}</td>
                    <td>{{ loan.timestamp.strftime('%Y-%m-%d') }}</td>
                    <td>Repaid</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        async function createLoan(event) {
            event.preventDefault();
            const form = event.target;
            const data = {
                lender_id: parseInt(form.lender_id.value),
                borrower_id: parseInt(form.borrower_id.value),
                points: parseInt(form.points.value),
                use_year: parseInt(form.use_year.value)
            };

            try {
                const response = await fetch('/api/loans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert(result.error || 'Error recording point sharing');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }

        async function handleRepayLoan(loanId) {
            if (!confirm('Are you sure you want to repay this loan?')) {
                return;
            }

            try {
                const response = await fetch(`/api/loans/${loanId}/repay`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert('Error repaying loan: ' + error.message);
            }
        }
    </script>
</body>
</html>
{% endblock %}
