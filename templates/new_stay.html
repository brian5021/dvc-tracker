{% extends "base.html" %}

{% block title %}New Stay{% endblock %}

{% block content %}
<div class="container">
    <h1>New Stay</h1>
    <form id="stayForm" class="stay-form">
        <div class="form-section">
            <h2>Stay Details</h2>
            <div class="form-group">
                <label for="resort">Resort:</label>
                <input type="text" id="resort" name="resort" required>
            </div>

            <div class="form-group">
                <label for="check_in">Check-in:</label>
                <input type="date" id="check_in" name="check_in" required>
            </div>

            <div class="form-group">
                <label for="check_out">Check-out:</label>
                <input type="date" id="check_out" name="check_out" required>
            </div>

            <div class="form-group">
                <label for="points_cost">Total Points:</label>
                <input type="number" id="points_cost" name="points_cost" required min="1">
            </div>

            <div class="form-group">
                <label for="status">Status:</label>
                <select id="status" name="status" required>
                    <option value="Planned">Planned</option>
                    <option value="Booked">Booked</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
        </div>

        <div class="form-section">
            <h2>Members</h2>
            <div id="members-container"></div>
            <button type="button" id="add-member">Add Member</button>
            <div class="points-summary">
                Total Points Allocated: <span id="total-points">0</span>
                <span id="points-warning" style="color: red; display: none;">
                    Points allocation does not match total cost
                </span>
            </div>
        </div>

        <div class="form-section">
            <h2>Guests</h2>
            <div id="guests-container"></div>
            <button type="button" id="add-guest">Add Guest</button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">Create Stay</button>
            <a href="{{ url_for('home') }}" class="btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('stayForm');
    const membersContainer = document.getElementById('members-container');
    const guestsContainer = document.getElementById('guests-container');
    const addMemberBtn = document.getElementById('add-member');
    const addGuestBtn = document.getElementById('add-guest');
    const pointsCostInput = document.getElementById('points_cost');
    const totalPointsSpan = document.getElementById('total-points');
    const pointsWarning = document.getElementById('points-warning');

    // Define helper functions first
    function createMemberRow() {
        const div = document.createElement('div');
        div.className = 'member-row';
        div.innerHTML = `
            <select class="member-select" required>
                {% for member in members %}
                    <option value="{{ member.id }}">{{ member.name }}</option>
                {% endfor %}
            </select>
            <input type="number" class="points-share" required min="0">
            <button type="button" class="remove-member">Remove</button>
        `;
        return div;
    }

    function createGuestRow() {
        const div = document.createElement('div');
        div.className = 'guest-row';
        div.innerHTML = `
            <select class="guest-select" required>
                {% for guest in guests %}
                    <option value="{{ guest.id }}">{{ guest.name }}</option>
                {% endfor %}
            </select>
            <button type="button" class="remove-guest">Remove</button>
        `;
        return div;
    }

    function updatePointShares() {
        const totalPoints = parseInt(pointsCostInput.value) || 0;
        const memberRows = membersContainer.querySelectorAll('.member-row');
        if (memberRows.length === 0) return;

        const pointsPerMember = Math.floor(totalPoints / memberRows.length);
        const remainder = totalPoints % memberRows.length;

        memberRows.forEach((row, index) => {
            const pointsInput = row.querySelector('.points-share');
            pointsInput.value = pointsPerMember + (index < remainder ? 1 : 0);
        });

        updateTotalPoints();
    }

    function updateTotalPoints() {
        let total = 0;
        membersContainer.querySelectorAll('.points-share').forEach(input => {
            total += parseInt(input.value) || 0;
        });
        totalPointsSpan.textContent = total;

        const targetPoints = parseInt(pointsCostInput.value) || 0;
        pointsWarning.style.display = total !== targetPoints ? 'inline' : 'none';
    }

    // Add event listeners
    if (addMemberBtn) {
        addMemberBtn.addEventListener('click', () => {
            membersContainer.appendChild(createMemberRow());
            updatePointShares();
        });
    }

    if (addGuestBtn) {
        addGuestBtn.addEventListener('click', () => {
            guestsContainer.appendChild(createGuestRow());
        });
    }

    // Remove member/guest handlers
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-member')) {
            e.target.closest('.member-row').remove();
            updatePointShares();
        } else if (e.target.classList.contains('remove-guest')) {
            e.target.closest('.guest-row').remove();
        }
    });

    // Points cost change handler
    pointsCostInput.addEventListener('change', updatePointShares);

    // Form submission handler
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = {
            resort: document.getElementById('resort').value,
            check_in: document.getElementById('check_in').value,
            check_out: document.getElementById('check_out').value,
            points_cost: parseInt(pointsCostInput.value),
            status: document.getElementById('status').value,
            members: [],
            guests: []
        };

        membersContainer.querySelectorAll('.member-row').forEach(row => {
            formData.members.push({
                member_id: parseInt(row.querySelector('.member-select').value),
                points_share: parseInt(row.querySelector('.points-share').value)
            });
        });

        guestsContainer.querySelectorAll('.guest-row').forEach(row => {
            formData.guests.push(parseInt(row.querySelector('.guest-select').value));
        });

        fetch('{{ url_for("new_stay") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                window.location.href = '{{ url_for("home") }}';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the stay');
        });
    });
});
</script>
{% endblock %}
